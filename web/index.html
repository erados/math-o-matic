<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="../dist/math.js"></script>
		<script src="./code-propositional.js"></script>
		<script src="./docs-propositional.js"></script>
		<script src="./nativeMap.js"></script>
		<script src="./katex/katex.min.js"></script>
		<link rel="stylesheet" href="./katex/katex.min.css">
		<style>
			* {
				tab-size: 4;
			}

			pre {
				white-space: pre-wrap;
			}

			a {
				color: inherit;
			}

			.block {
				padding: 1em;
				background-color: #f8f8f8;
				border: 1px #ccc solid;
				border-radius: 3px;
				margin: 1em 0;
			}

			.label {
				margin-top: 0;
			}

			.katex a {
				text-decoration: none;
				color: inherit;
			}

			.katex a > :not(.mspace) {
				background-color: #E8F5E9;
			}
		</style>
	</head>
	<body style="font-family: monospace;">
		<h1>M42/math</h1>
		<div id="simple-types">
			<h2>Simple types</h2>
		</div>
		<div id="typevars">
			<h2>Typevars</h2>
		</div>
		<div id="rules">
			<h2>Rules</h2>
		</div>
		<div id="code">
			<h2>The code</h2>
		</div>
		<script>
			$ = (q, n) => (n || document).querySelector(q);
			$$ = (q, n) => (n || document).querySelectorAll(q);

			var katexOpts = {
				trust: context => {
					if (context.command != '\\href') return false;
					if (context.protocol != '_relative') return false;
					return true;
				}
			}

			var escapeHtml = s => (s + '').replace(/[&<>"']/g, m => ({
			    '&': '&amp;', '<': '&lt;', '>': '&gt;',
			    '"': '&quot;', "'": '&#39;'
			})[m]);

			$('#code').innerHTML +=
				`<pre>${escapeHtml(code)}</pre>`;

			console.log('--- PARSE START ---');
			var parsed, err;
			try {
				parsed = math.parser.parse(code);
			} catch (e) {
				console.error(e);
				console.error(`Error: ${e.message}\n\tat ${e.location.start.line}:${e.location.start.column}`);
				console.log('--- PARSE FAILED ---');
				err = e;
			}

			if (!err) {
				console.log(JSON.stringify(parsed, null, 2));
				console.log('--- PARSE END ---');
				console.log('--- PROCESS START --');
				var program = math.process(parsed, nativeMap);
				console.log(program);

				if (docs.typevars) {
					for (k in docs.typevars) {
						var typevar = docs.typevars[k];

						if (typevar.display)
							program.scope.typevarMap[k].funcallToTeXString = typevar.display;
					}
				}

				for (var k in program.scope.simpleTypeMap) {
					var v = program.scope.simpleTypeMap[k];

					$('#simple-types').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="type-${k}" href="#type-${k}"><b>Type</b> ${k}</a></p>`
						+ `<div>${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.simpleTypes && docs.simpleTypes[k] && docs.simpleTypes[k].description
							? `<p class="description">${escapeHtml(docs.simpleTypes[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.typevarMap) {
					var v = program.scope.typevarMap[k];

					$('#typevars').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="typevar-${k}" href="#typevar-${k}"><b>Typevar</b> ${k}</a></p>`
						+ `<div>${katex.renderToString(v.toTeXString(true), katexOpts)}</div>`
						+ (
							docs.typevars && docs.typevars[k] && docs.typevars[k].description
							? `<p class="description">${escapeHtml(docs.typevars[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.ruleMap) {
					var v = program.scope.ruleMap[k];

					$('#rules').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="rule-${k}" href="#rule-${k}"><b>Rule</b> ${k}</a></p>`
						+ `<div>${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.rules && docs.rules[k] && docs.rules[k].description
							? `<p class="description">${escapeHtml(docs.rules[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				[].forEach.call($$('.katex a'), a => {
					a.title = a.getAttribute('href');
				});

				console.log('--- PROCESS END ---');
			}
		</script>
	</body>
</html>