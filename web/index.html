<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="../dist/math.js"></script>
		<script src="./code.js"></script>
		<script src="./docs.js"></script>
		<script src="./katex/katex.min.js"></script>
		<link rel="stylesheet" href="./katex/katex.min.css">
		<style>
			* {
				tab-size: 4;
			}

			pre {
				white-space: pre-wrap;
			}

			.block {
				padding: 1em;
				background-color: #f8f8f8;
				border: 1px #ccc solid;
				border-radius: 3px;
				margin: 1em 0;
			}

			.label {
				margin-top: 0;
			}
		</style>
	</head>
	<body style="font-family: monospace;">
		<div id="code">
			<h2>The code</h2>
		</div>
		<div id="simple-types">
			<h2>Simple types</h2>
		</div>
		<div id="typevars">
			<h2>Typevars</h2>
		</div>
		<div id="rules">
			<h2>Rules</h2>
		</div>
		<div>
			<h2>Log</h2>
			<pre id="log"></pre>
		</div>
		<script>
			$ = (q, n) => (n || document).querySelector(q);

			function log(s) {
				$('#log').innerText += s + '\n';
			}

			var escapeHtml = s => (s + '').replace(/[&<>"']/g, m => ({
			    '&': '&amp;', '<': '&lt;', '>': '&gt;',
			    '"': '&quot;', "'": '&#39;'
			})[m]);

			$('#code').innerHTML +=
				`<pre>${escapeHtml(code)}</pre>`;

			log('--- PARSE START ---');
			var parsed, err;
			try {
				parsed = math.parser.parse(code);
			} catch (e) {
				console.log(e);
				error(`Error: ${e.message}\n\tat ${e.location.start.line}:${e.location.start.column}`);
				log('--- PARSE FAILED ---');
				err = e;
			}

			if (!err) {
				log(JSON.stringify(parsed, null, 2));
				log('--- PARSE END ---');
				log('--- PROCESS START --');
				var program = math.process(parsed);
				console.log(program);

				if (docs.typevars) {
					for (k in docs.typevars) {
						var typevar = docs.typevars[k];

						if (typevar.display)
							program.scope.typevarMap[k].funcallToTeXString = typevar.display;
					}
				}

				for (var k in program.scope.simpleTypeMap) {
					var v = program.scope.simpleTypeMap[k];

					$('#simple-types').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><b>Type</b> ${k}</p>`
						+ `<div>${katex.renderToString(v.toTeXString())}</div>`
						+ (
							docs.simpleTypes && docs.simpleTypes[k] && docs.simpleTypes[k].description
							? `<p class="description">${escapeHtml(docs.simpleTypes[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.typevarMap) {
					var v = program.scope.typevarMap[k];

					$('#typevars').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><b>Typevar</b> ${k}</p>`
						+ `<div>${katex.renderToString(v.toTeXString())}</div>`
						+ (
							docs.typevars && docs.typevars[k] && docs.typevars[k].description
							? `<p class="description">${escapeHtml(docs.typevars[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.ruleMap) {
					var v = program.scope.ruleMap[k];

					$('#rules').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><b>Rule</b> ${k}</p>`
						+ `<div>${katex.renderToString(v.toTeXString())}</div>`
						+ (
							docs.rules && docs.rules[k] && docs.rules[k].description
							? `<p class="description">${escapeHtml(docs.rules[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				log('--- PROCESS END ---');
			}
		</script>
	</body>
</html>