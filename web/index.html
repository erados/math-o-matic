<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<title>M42/math</title>
		<script src="../dist/math.js"></script>
		<script src="./code.js"></script>
		<script src="./docs.js"></script>
		<script src="./nativeMap.js"></script>
		<script src="./katex/katex.min.js"></script>
		<script src="./m42kup.js"></script>
		<link rel="stylesheet" href="./katex/katex.min.css">
		<style>
			* {
				tab-size: 4;
			}

			body {
				font-size: 14px;
				font-family: monospace, monospace;
			}

			p {
				margin: 0;
			}

			p + p {
				margin-top: 1em;
			}

			pre {
				white-space: pre-wrap;
			}

			a {
				color: inherit;
			}

			.block {
				padding: 1em;
				background-color: #f8f8f8;
				border: 1px #ccc solid;
				border-radius: 3px;
				margin: 1em 0;
			}

			.label {
				margin-top: 0;
				margin-bottom: 1em;
			}

			.description {
				margin: 1em 0;
			}

			.math {
				font-size: 1.2em;
			}

			.katex a {
				text-decoration: none;
				color: inherit;
			}

			.katex a > :not(.mspace) {
				background-color: #E8F5E9;
			}
		</style>
	</head>
	<body>
		<h1>M42/math</h1>
		<div id="simple-types">
			<h2>Simple types</h2>
		</div>
		<div id="typevars">
			<h2>Typevars</h2>
		</div>
		<div id="links">
			<h2>Links</h2>
		</div>
		<div id="rulesets">
			<h2>Rulesets</h2>
		</div>
		<div id="rules">
			<h2>Rules</h2>
		</div>
		<div id="code">
			<h2>The code</h2>
		</div>
		<script>
			$ = (q, n) => (n || document).querySelector(q);
			$$ = (q, n) => (n || document).querySelectorAll(q);

			var katexOpts = {
				trust: context => {
					if (context.command != '\\href') return false;
					if (context.protocol != '_relative') return false;
					return true;
				}
			}

			m42kup.set({
				katex
			});

			var escapeHtml = s => (s + '').replace(/[&<>"']/g, m => ({
			    '&': '&amp;', '<': '&lt;', '>': '&gt;',
			    '"': '&quot;', "'": '&#39;'
			})[m]);

			$('#code').innerHTML +=
				`<pre>${escapeHtml(code)}</pre>`;

			console.log('--- PARSE START ---');
			var parseStartTime = new Date() * 1;
			var parsed, err;
			try {
				parsed = math.parser.parse(code);
			} catch (e) {
				console.error(e);
				console.error(`Error: ${e.message}\n\tat ${e.location.start.line}:${e.location.start.column}`);
				console.log('--- PARSE FAILED ---');
				err = e;
			}

			var parseEndTime = new Date() * 1;

			if (!err) {
				console.log(parsed);
				console.log('--- PARSE END ---');
				console.log(`Parse ended in ${parseEndTime - parseStartTime} ms`);
				console.log('--- PROCESS START --');
				var processStartTime = new Date() * 1;

				var program = new math.Program();
				program.feed(parsed, nativeMap);

				var processEndTime = new Date() * 1;
				console.log(program);
				console.log('--- PROCESS END ---');
				console.log(`Process ended in ${processEndTime - processStartTime} ms`);
				console.log('--- HTML RENDER START ---');
				var renderStartTime = new Date() * 1;

				if (docs.typevars) {
					for (k in docs.typevars) {
						var typevar = docs.typevars[k];

						if (typevar.display) {
							if (program.scope.typevarMap[k]) {
								if (program.scope.typevarMap[k]._type == 'fun')
									program.scope.typevarMap[k].funcallToTeXString = typevar.display;
								else
									program.scope.typevarMap[k].toTeXString = typevar.display;
							}
						}
					}
				}

				for (var k in program.scope.simpleTypeMap) {
					var v = program.scope.simpleTypeMap[k];

					$('#simple-types').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="type-${k}" href="#type-${k}"><b>Type</b> ${k}</a></p>`
						+ `<div class="math">${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.simpleTypes && docs.simpleTypes[k] && docs.simpleTypes[k].description
							? `<p class="description">${m42kup.render(docs.simpleTypes[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.typevarMap) {
					var v = program.scope.typevarMap[k];

					$('#typevars').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="typevar-${k}" href="#typevar-${k}"><b>Typevar</b> ${k}</a></p>`
						+ `<div class="math">${katex.renderToString(v.toTeXString(true), katexOpts)}</div>`
						+ (
							docs.typevars && docs.typevars[k] && docs.typevars[k].description
							? `<p class="description">${m42kup.render(docs.typevars[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.linkMap) {
					var v = program.scope.linkMap[k];

					$('#links').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="link-${k}" href="#link-${k}"><b>Link</b> ${k}</a></p>`
						+ `<div class="math">${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.links && docs.links[k] && docs.links[k].description
							? `<p class="description">${m42kup.render(docs.links[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.rulesetMap) {
					var v = program.scope.rulesetMap[k];

					$('#rulesets').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="ruleset-${k}" href="#ruleset-${k}"><b>Ruleset</b> ${k}</a></p>`
						+ `<div class="math">${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.rulesets && docs.rulesets[k] && docs.rulesets[k].description
							? `<p class="description">${m42kup.render(docs.rulesets[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				for (var k in program.scope.ruleMap) {
					var v = program.scope.ruleMap[k];

					$('#rules').innerHTML +=
						`<div class="block">`
						+ `<p class="label"><a id="rule-${k}" href="#rule-${k}"><b>Rule</b> ${k}</a></p>`
						+ `<div class="math">${katex.renderToString(v.toTeXString(), katexOpts)}</div>`
						+ (
							docs.rules && docs.rules[k] && docs.rules[k].description
							? `<p class="description">${m42kup.render(docs.rules[k].description)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						// + `<pre>${escapeHtml(v)}</pre>`
						+ `</div>`;
				}

				[].forEach.call($$('.katex a'), a => {
					a.title = a.getAttribute('href');
				});

				var renderEndTime = new Date() * 1;
				console.log('--- HTML RENDER END ---');
				console.log(`HTML render ended in ${renderEndTime - renderStartTime} ms`);
			}
		</script>
	</body>
</html>