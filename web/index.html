<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 minimum-scale=1.0">
		<title>math-o-matic</title>
		<script src="../dist/math.js"></script>
		<script src="./native.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/m42kup@0.2.1/dist/m42kup.min.js"></script>
		<script>
			m42kup.set({
				katex
			});

			$ = (q, n) => (n || document).querySelector(q);
			$$ = (q, n) => (n || document).querySelectorAll(q);
		</script>
		<script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
		<script src="./getProofExplorer.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<h1>math-o-matic</h1>
		<a href="https://github.com/logico-philosophical/math-o-matic">repo</a> &middot; <a href="../docs/build/index.html">docs</a>
		<h2>개요</h2>
		이 페이지는 math-o-matic으로 만들고 있는 공리계를 보여 줍니다. 우상단의 로드 버튼을 눌러서 공리계를 로드하세요. 장치의 계산 성능에 따라 몇십 초 가량의 시간이 걸릴 수 있습니다.
		<h2>로컬에서 실행하는 방법</h2>
		<p>로컬에서 file 스킴으로 페이지를 불러왔을 경우 CORS 정책에 의해 페이지가 작동하지 않을 수 있습니다. 이때 다음과 같은 해결책이 있습니다.</p>
		<ul>
			<li> 로컬 서버를 통해 접속하기. 이는 npm의 <a href="https://www.npmjs.com/package/http-server">http-server</a> 패키지를 사용하여 할 수 있습니다.
			<li> Chrome의 경우 <code>--allow-file-access-from-files</code> 플래그를 통해 로컬 파일 로드를 가능하게 할 수 있습니다. <a href="https://stackoverflow.com/a/18137280">StackOverflow 링크</a>
		</ul>
		<h2>핫키</h2>
		<ul>
			<li><kbd>S</kbd>: 검색
			<li><kbd>R</kbd>: 로드, 다시 로드
			<li><kbd>Backspace</kbd>, <kbd>J</kbd>: 뒤로가기
			<li><kbd>K</kbd>: 앞으로 가기
		</ul>
		<h2>우상단 컨트롤에 관하여</h2>
		<ul>
			<li>검색창은 <kbd>S</kbd> 키를 눌러 활성화시킬 수 있으며 정의 및 스키마의 검색을 가능하게 합니다. <kbd>Tab</kbd> 및 <kbd>Shift</kbd> + <kbd>Tab</kbd> 및 <kbd>&darr;</kbd> 및 <kbd>&uarr;</kbd> 및 <kbd>Enter</kbd> 및 <kbd>Esc</kbd>를 써서 조작할 수 있으니 시도해 보세요.
			<li>reload 버튼은 <kbd>R</kbd> 키를 눌러 클릭할 수 있으며 <a href="./code.math">code.math</a> 파일을 다시 불러와서 목록을 재작성합니다. 단 그 과정에서 에러가 발생하였을 경우 이전 목록이 보존되므로 새로운 코드를 작성할 때 유용하게 사용할 수 있습니다.
		</ul>
		<h2>연산자 우선순위</h2>
		<div id="precedence">[로드하세요]</div>
		<h2>목록</h2>
		<p>이하의 내용은
			<a href="./code.math">code.math</a> 및
			<a href="./native.js">native.js</a>에 있는 코드를 렌더링 한 것입니다.</p>
		<div id="search-background" style="position:fixed;top:0;bottom:0;left:0;right:0;z-index:5000;display:none;"></div>
		<div style="position:fixed;top:5px;right:5px;z-index:10000;">
			<div>
				<input id="search" type="text" placeholder="search">
				<input id="reload" type="button" class="colored" value="" style="text-transform: uppercase;">
			</div>
			<div id="search-dropdown" style="display: none;">
				<ul></ul>
			</div>
			<script src="./search.js"></script>
		</div>
		<div id="all">[로드하세요]</div>
		<script>
			var katexOpts = {
				trust: context => {
					if (context.command != '\\href') return false;
					if (context.protocol != '_relative') return false;
					return true;
				}
			}

			var ktx = s => {
				var ret = '';
				try {
					ret = katex.renderToString(s, katexOpts);
				} catch (e) {
					console.error(`Error parsing ${s}`);
					throw Error(e);
				}

				return ret;
			}

			var loading = false;

			function load(code) {
				if (loading) return;
				loading = true;

				try {

				var start, end;

				console.log('--- PARSE START ---');
				start = new Date();
				var parsed;
				try {
					parsed = math.parser.parse(code);
				} catch (e) {
					console.error(`Error: ${e.message}\n    at code.math:${e.location.start.line}:${e.location.start.column}`);
					console.log('--- PARSE FAILED ---');
					return;
				}

				end = new Date();
				console.log(parsed);
				console.log('--- PARSE END ---');
				console.log(`Parse ended in ${end - start} ms`);
				console.log('--- PROCESS START ---');
				start = new Date();

				program = new math.Program();
				program.feed(parsed, native);

				end = new Date();
				console.log(program);
				console.log('--- PROCESS END ---');
				console.log(`Process ended in ${end - start} ms`);
				console.log('--- HTML GENERATION START ---');
				start = new Date();

				var precedenceMap = new Map();

				for (var k in program.scope.defMap) {
					var prec = program.scope.defMap[k].precedence;
					if (prec) {
						if (precedenceMap.has(prec)) {
							precedenceMap.set(prec, precedenceMap.get(prec).concat([k]));
						} else {
							precedenceMap.set(prec, [k]);
						}	
					}
				}

				precedenceMap = [...precedenceMap].sort((a, b) => a[0] - b[0]);

				$('#precedence').innerHTML = `
				<p>현재 연산자 우선순위는 다음과 같습니다.</p>

				<table>
					<tr><td>우선순위</td><td>연산자</td></tr>
					${precedenceMap.map(([k, v]) => {
						return `<tr><td>${k}</td><td>${v.map(w => {
							return `<a href="#def-${w}">${w}</a>`;
						}).join(', ')}</td></tr>`;
					}).join('')}
				</table>

				<p>위 표는 자동으로 생성되었습니다.</p>`;

				var arr = {}, r;

				for (var k in program.scope.typedefMap) {
					var v = program.scope.typedefMap[k];

					r = `<div class="block">`
						+ `<p class="label"><a id="type-${k}" href="#type-${k}"><b>${
							(v.isBaseType ? 'base ' : '')
						}type</b> ${k}</a></p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `</div>`;

					arr[v._id] = r;
				}

				for (var k in program.scope.defMap) {
					var v = program.scope.defMap[k];

					r = `<div class="block">`
						+ `<p class="label"><a id="def-${k}" href="#def-${k}"><b>definition</b> ${k}</a>${v.type.isSimple
								? ''
								: `(${v.params.map(p => p.toSimpleString()).join(', ')})`
									+ `: ${v.type.resolve().to}`
						}</p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `</div>`;

					arr[v._id] = r;
				}

				for (var k in program.scope.schemaMap) {
					var v = program.scope.schemaMap[k];

					r = `<div class="block">`
						+ `<p class="label"><a id="schema-${k}" href="#schema-${k}"><b>${
							(v.axiomatic ? 'axiomatic ' : '')
							+ (v.native ? 'native ': '')
						}schema</b> ${k}</a>${v.native ? '' : `(${v.params.map(p => p.toSimpleString()).join(', ')})`}</p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ (
							v.expr
								? v.axiomatic
									? ''
									: '<p class="label"><b>proof explorer</b></p>'
										+ `<p>${getProofExplorer(v.expr)}</p>`
								: ''
						)

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)

						+ (
							v.native || v.params.every(p => !p.guess)
								? ''
								: '<p class="label"><b>guesses</b></p>'
									+ `<ul>${v.params.filter(p => p.guess).map(p => {
										return `<li>${p.name}: @${p.guess}</li>`;
									}).join('')}</ul>`
						)

						+ `</div>`;

					arr[v._id] = r;
				}

				for (var k in program.scope.rulesetMap) {
					var v = program.scope.rulesetMap[k];

					r = `<div class="block">`
						+ `<p class="label"><a id="ruleset-${k}" href="#ruleset-${k}"><b>${
							(v.axiomatic ? 'axiomatic ' : '')
							+ (v.native ? 'native ' : '')
						}ruleset</b> ${k}</a></p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ (
							v.axiomatic
								? '' : '<p class="label"><b>not proved</b></p>'
						)

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `</div>`;

					arr[v._id] = r;
				}

				end = new Date();
				console.log('--- HTML GENERATION END ---');
				console.log(`HTML generation ended in ${end - start} ms`);
				console.log('--- HTML RENDER START ---');
				start = new Date();

				$('#all').innerHTML =
					Object.keys(arr).sort((l, r) => l._id - r._id).map(k => arr[k]).join('');

				[].forEach.call($$('.katex a'), a => {
					var href = a.getAttribute('href');
					var idMatch = href.match(/^#id-([0-9]+)$/);
					var defMatch = href.match(/^#def-.+$/);
					var schemaMatch = href.match(/^(#schema-.+?)-(p|np)$/);
					var elseMatch = href.match(/^#(type|ruleset)-.+$/);

					if (idMatch) {
						a.dataset.orange = true;
						a.title = 'id: ' + idMatch[1];
					} else if (defMatch) {
						a.dataset.blue = true;
						a.title = a.getAttribute('href');
					} else if (schemaMatch) {
						var proved = schemaMatch[2] == 'p';

						if (proved) {
							a.dataset.green = true;	
						} else {
							a.dataset.red = true;
						}
						
						a.setAttribute('href', schemaMatch[1]);
						a.title = schemaMatch[1];
					} else if (elseMatch) {
						a.dataset.green = true;
						a.title = elseMatch[0];
					}
				});

				end = new Date();
				console.log('--- HTML RENDER END ---');
				console.log(`HTML render ended in ${end - start} ms`);

				} finally {
					loading = false;
				}
			}

			hotkeys('r', (evt, handler) => {
				evt.preventDefault();
				reload();
			});

			hotkeys('backspace,j', (evt, handler) => {
				evt.preventDefault();
				history.back();
			});

			hotkeys('k', (evt, handler) => {
				evt.preventDefault();
				history.forward();
			});

			var reloading = false;
			$('#reload').value = 'load';

			function reload() {
				if (reloading) return;
				reloading = true;

				$('#reload').value = 'loading...';

				var xhr = new XMLHttpRequest();
				xhr.addEventListener('load', () => {
					try {
						load(xhr.responseText);
					} finally {
						$('#reload').value = 'reload';
						reloading = false;
					}
				});
				xhr.addEventListener('error', () => {
					console.log('LOAD FAILED');
					$('#reload').value = 'reload';
					reloading = false;
				});
				xhr.open('GET', './code.math');
				xhr.send();
			}

			$('#reload').addEventListener('click', reload);
		</script>
	</body>
</html>