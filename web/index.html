<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 minimum-scale=1.0">
		<title>math-o-matic</title>
		<script src="../dist/math.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/m42kup@0.2.1/dist/m42kup.min.js"></script>
		<script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/addon/hint/show-hint.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/addon/display/placeholder.js"></script>
		<script src="./peg-0.10.0.min.js"></script>
		<script>
			m42kup.set({
				katex
			});

			$ = (q, n) => (n || document).querySelector(q);
			$$ = (q, n) => (n || document).querySelectorAll(q);

			var escapeHtml = s => (s + '').replace(/[&<>"']/g, m => ({
					'&': '&amp;', '<': '&lt;', '>': '&gt;',
					'"': '&quot;', "'": '&#39;'
			})[m]);

			var start, end;
			console.log('--- PARSER GENERATION START ---');
			start = new Date();
			var parser = peg.generate(math.grammar, {cache: true});
			var evalParser = peg.generate(math.grammar, {
				cache: true,
				allowedStartRules: ['evaluable']
			})
			end = new Date();
			console.log('--- PARSER GENERATION END ---');
			console.log(`Parser generation ended in ${end - start} ms`);
		</script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/addon/hint/show-hint.min.css">
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<div id="search-background" style="position:fixed;top:0;bottom:0;left:0;right:0;z-index:5000;display:none;"></div>
		<div style="position:fixed;top:5px;right:5px;z-index:10000;">
			<div>
				<input id="button-expand-all" type="button" class="colored" value="expand all" style="text-transform: uppercase;">
				<input id="reload" type="button" class="colored" value="" style="text-transform: uppercase;">
				<input id="button-show-console" type="button" class="colored" value="console" style="text-transform: uppercase;">
			</div>
		</div>
		<div class="console-wrap-wrap" style="display:none">
		  <div class="console-wrap">
		    <div id="console-display-wrap">
		    	<table id="console-display" style="margin: 0"></table>
		    	<div id="search-dropdown" style="display: none;">
						<ul></ul>
					</div>
		    </div>
	    	<script src="./console.js"></script>
	    </div>
	  </div>
		<h1>math-o-matic</h1>
		<a href="https://github.com/logico-philosophical/math-o-matic">repo</a> &middot; <a href="../docs/build/index.html">docs</a>
		<h2>개요</h2>
		이 페이지는 math-o-matic으로 만들고 있는 공리계를 보여 줍니다. 우상단의 로드 버튼을 눌러서 공리계를 로드하세요. 장치의 계산 성능에 따라 수 초 가량의 시간이 걸릴 수 있습니다.
		<h2>로컬에서 실행하는 방법</h2>
		<p>로컬에서 file 스킴으로 페이지를 불러왔을 경우 CORS 정책에 의해 페이지가 작동하지 않을 수 있습니다. 이때 다음과 같은 해결책이 있습니다.</p>
		<ul>
			<li> 로컬 서버를 통해 접속하기. 이는 npm의 <a href="https://www.npmjs.com/package/http-server">http-server</a> 패키지를 사용하여 할 수 있습니다.
			<li> Chrome의 경우 <code>--allow-file-access-from-files</code> 플래그를 통해 로컬 파일 로드를 가능하게 할 수 있습니다. <a href="https://stackoverflow.com/a/18137280">StackOverflow 링크</a>
		</ul>
		<h2>핫키</h2>
		<ul>
			<li><kbd>X</kbd>: 증명 전부 펼치기
			<li><kbd>R</kbd>, <kbd>F7</kbd>: 로드, 다시 로드
			<li><kbd>C</kbd>: 콘솔 여닫기
			<li><kbd>Backspace</kbd>, <kbd>J</kbd>: 뒤로가기
			<li><kbd>K</kbd>: 앞으로 가기
		</ul>
		<h2>몇 가지 컨트롤에 관하여</h2>
		<ul>
			<li>expand all 버튼은 <kbd>X</kbd> 키를 눌러 클릭할 수 있으며 증명탐색을 전부 활성화합니다. 성능에 부정적 영향이 있을 수 있습니다.
			<li>reload 버튼은 <kbd>R</kbd> 키를 눌러 클릭할 수 있으며 <a href="./code.math">code.math</a> 파일을 다시 불러와서 목록을 재작성합니다. 단 그 과정에서 에러가 발생하였을 경우 이전 목록이 보존되므로 새로운 코드를 작성할 때 유용하게 사용할 수 있습니다.
			<li>콘솔은 <kbd>C</kbd> 키를 눌러 열 수 있으며 REPL 기능을 제공합니다. <kbd>Ctrl</kbd> + <kbd>L</kbd>을 누르면 콘솔 내용이 지워집니다.
		</ul>
		<h2>연산자 우선순위</h2>
		<div id="precedence">[로드하세요]</div>
		<h2>목록</h2>
		<div id="summary"></div>
		<p>이하의 내용은
			<a href="./code.math">code.math</a>에 있는 코드를 렌더링 한 것입니다.</p>
		<div id="all">[로드하세요]</div>
		<script>
			var katexOpts = {
				trust: context => {
					if (context.command != '\\href') return false;
					if (context.protocol != '_relative') return false;
					return true;
				}
			}

			var ktx = s => {
				var ret = '';
				try {
					ret = katex.renderToString(s, katexOpts);
				} catch (e) {
					console.error(`Error parsing ${s}`);
					throw Error(e);
				}

				return ret;
			}

			var expansionList = [];

			var loading = false;

			function load(code) {
				if (loading) return;
				loading = true;

				try {

				var start, end;

				console.log('--- PARSE START ---');
				start = new Date();
				var parsed;
				try {
					parsed = parser.parse(code);
				} catch (e) {
					console.error(`Error: ${e.message}\n    at code.math:${e.location.start.line}:${e.location.start.column}`);
					console.log('--- PARSE FAILED ---');
					return;
				}

				end = new Date();
				console.log(parsed);
				console.log('--- PARSE END ---');
				console.log(`Parse ended in ${end - start} ms`);
				console.log('--- PROCESS START ---');
				start = new Date();

				program = new math.Program();
				program.feed(parsed);

				end = new Date();
				console.log(program);
				console.log('--- PROCESS END ---');
				console.log(`Process ended in ${end - start} ms`);
				console.log('--- HTML GENERATION START ---');
				start = new Date();

				var precedenceMap = new Map();

				for (var [k, v] of program.scope.defMap) {
					var prec = v.precedence;
					if (prec) {
						if (precedenceMap.has(prec)) {
							precedenceMap.set(prec, precedenceMap.get(prec).concat([k]));
						} else {
							precedenceMap.set(prec, [k]);
						}	
					}
				}

				precedenceMap = [...precedenceMap].sort((a, b) => a[0] - b[0]);

				$('#precedence').innerHTML = `
				<p>현재 연산자 우선순위는 다음과 같습니다.</p>

				<table>
					<tr><td>우선순위</td><td>연산자</td></tr>
					${precedenceMap.map(([k, v]) => {
						return `<tr><td>${k}</td><td>${v.map(w => {
							return `<a href="#def-${w}">${w}</a>`;
						}).join(', ')}</td></tr>`;
					}).join('')}
				</table>

				<p>위 표는 자동으로 생성되었습니다.</p>`;

				var axiomSchemaList = [...program.scope.schemaMap]
						.filter(([k, v]) => v.axiomatic).map(([k, v]) => k);

				var notProvedList = [...program.scope.schemaMap]
						.filter(([k, v]) => !v.proved).map(([k, v]) => k);

				$('#summary').innerHTML = `
				<ul>
					<li><b>공리 스키마</b>(${axiomSchemaList.length}): ${
						axiomSchemaList.map(n => `<a href="#schema-p-${n}">${n}</a>`).join(', ')}
					<li><b>증명되지 않은 스키마</b>(${notProvedList.length}): ${
						notProvedList.map(n => `<a href="#schema-np-${n}">${n}</a>`).join(', ')}
				</ul>`;

				var arr = {}, r;

				for (var [k, v] of program.scope.typedefMap) {
					r = `<div class="block">`
						+ `<p class="label"><a id="type-${k}" href="#type-${k}"><b>${
							(v.isBaseType ? 'base ' : '')
						}type</b> ${k}</a></p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `</div>`;

					arr[v._id] = r;
				}

				for (var [k, v] of program.scope.defMap) {
					r = `<div class="block">`
						+ `<p class="label"><a id="def-${k}" href="#def-${k}"><b>definition</b> ${k}</a>${v.type.isSimple
								? ''
								: `(${v.params.map(p => p.toSimpleString()).join(', ')})`
									+ `: ${v.type.resolve().to}`
						}</p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)
						+ `</div>`;

					arr[v._id] = r;
				}

				for (var [k, v] of program.scope.schemaMap) {
					r = `<div class="block">`
						+ `<p class="label"><a id="schema-${v.proved ? 'p' : 'np'}-${k}" href="#schema-${v.proved ? 'p' : 'np'}-${k}"><b>${
							(v.axiomatic ? 'axiomatic ' : '')
						}schema</b> ${k}</a>${`(${v.params.map(p => p.toSimpleString()).join(', ')})`}</p>`
						+ `<div class="math">${ktx(v.toTeXString(true, true))}</div>`

						+ (
							v.expr
								? v.axiomatic
									? ''
									: '<p class="label"><b>proof explorer</b></p>'
										+ (
											expansionList.includes(k)
												? `<p>${program.getProofExplorer(k, ktx)}</p>`
												: `<p><input type="button" value="show" class="colored button-expand-proof" onclick="this.parentElement.innerHTML = program.getProofExplorer('${k}', ktx);expansionList.push('${k}');"></p>`
										)
								: ''
						)

						+ '<p class="label"><b>description</b></p>'
						+ (
							v.doc
							? `<p class="description">${m42kup.render(v.doc)}</p>`
							: '<p class="description"><i>No description provided.</i></p>'
						)

						+ `</div>`;

					arr[v._id] = r;
				}

				end = new Date();
				console.log('--- HTML GENERATION END ---');
				console.log(`HTML generation ended in ${end - start} ms`);
				console.log('--- HTML RENDER START ---');
				start = new Date();

				$('#all').innerHTML =
					Object.keys(arr).sort((l, r) => l._id - r._id).map(k => arr[k]).join('');

				end = new Date();
				console.log('--- HTML RENDER END ---');
				console.log(`HTML render ended in ${end - start} ms`);

				} finally {
					loading = false;
				}
			}

			hotkeys('r,f7', (evt, handler) => {
				evt.preventDefault();
				reload();
			});

			hotkeys('backspace,j', (evt, handler) => {
				evt.preventDefault();
				history.back();
			});

			hotkeys('k', (evt, handler) => {
				evt.preventDefault();
				history.forward();
			});

			hotkeys('x', (evt, handler) => {
				evt.preventDefault();
				expandAll();
			});

			function expandAll() {
				$('#button-expand-all').value = 'expanding...';

				setTimeout(() => {
					$$('.button-expand-proof').forEach($ => {
						$.click();
					});

					$('#button-expand-all').value = 'expand all';
				}, 0);
			}

			$('#button-expand-all').addEventListener('click', expandAll);

			var reloading = false;
			$('#reload').value = 'load';

			function reload() {
				if (reloading) return;
				reloading = true;

				$('#reload').value = 'loading...';
				setTimeout(() => {
					var xhr = new XMLHttpRequest();
					xhr.addEventListener('load', () => {
						try {
							load(xhr.responseText);
						} finally {
							$('#reload').value = 'reload';
							reloading = false;
						}
					});
					xhr.addEventListener('error', () => {
						console.log('LOAD FAILED');
						$('#reload').value = 'reload';
						reloading = false;
					});
					xhr.open('GET', './code.math');
					xhr.send();
				}, 0);
			}

			$('#reload').addEventListener('click', reload);
		</script>
	</body>
</html>